<!DOCTYPE html>
<html>
<head>
     <meta charset="UTF-8">
    <title>Панель администратора</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .filters { background: #f5f5f5; padding: 15px; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 10px; }
        .status-pending { color: orange; }
        .status-confirmed { color: green; }
        .status-blocked { color: red; }
        button { margin: 2px; padding: 5px 10px; cursor: pointer; }
        .logout-btn { float: right; background: #e74c3c; color: white; border: none; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Панель администратора системы <button class="logout-btn" onclick="logout()">Выйти</button></h1>
    
    <div class="filters">
        <strong>Фильтры:</strong>
        <select id="filter-role" onchange="filterUsers()">
            <option value="">Все пользователи</option>
            <option value="client">Только клиенты</option>
            <option value="executor">Только исполнители</option>
            <option value="manager">Только менеджеры</option>
        </select>
        <select id="filter-status" onchange="filterUsers()">
            <option value="">Все статусы</option>
            <option value="pending">Ожидают подтверждения</option>
            <option value="confirmed">Подтвержденные</option>
            <option value="blocked">Заблокированные</option>
        </select>
        <input type="text" id="search-input" placeholder="Поиск по телефону или ФИО" onkeyup="searchUsers()">
    </div>
    
    <table id="users-table">
        <thead>
            <tr>
                <th>ID</th><th>ФИО</th><th>Телефон</th><th>Адрес</th>
                <th>Роль</th><th>Статус</th><th>Действия</th>
            </tr>
        </thead>
        <tbody id="users-tbody">
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">Загрузка...</td>
            </tr>
        </tbody>
    </table>
    
    <h2 style="margin-top: 30px;">Системные настройки</h2>
    <div>
        <label>Время ответа на заявку (часы):</label>
        <input type="number" id="response-time" value="24">
        <button onclick="saveSettings()">Сохранить</button>
    </div>

    <script src="api.js"></script>
    <script>
        let allUsers = [];
        
        async function checkAuth() {
            if (!api.getToken()) {
                window.location.href = 'index.html';
                return false;
            }
            
            try {
                const user = await api.getCurrentUser();
                if (user.role !== 'admin') {
                    alert('Доступ запрещен. Только для администраторов.');
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = 'index.html';
                return false;
            }
        }
        
        async function loadUsers() {
            try {
                allUsers = await api.getUsers();
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Ошибка загрузки пользователей');
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Пользователи не найдены</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const statusClass = user.status === 'pending' ? 'status-pending' : 
                                   user.status === 'confirmed' ? 'status-confirmed' : 'status-blocked';
                const statusText = user.status === 'pending' ? 'Ожидает подтверждения' : 
                                  user.status === 'confirmed' ? 'Подтвержден' : 'Заблокирован';
                
                const actionsHtml = user.status === 'pending' 
                    ? `<button onclick="confirmUser(${user.id})">Подтвердить</button>
                       <button onclick="rejectUser(${user.id})">Отклонить</button>`
                    : user.is_active
                    ? `<button onclick="blockUser(${user.id})">Заблокировать</button>`
                    : `<button onclick="unblockUser(${user.id})">Разблокировать</button>`;
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.fullname}</td>
                    <td>${user.username}</td>
                    <td>${user.address || '-'}</td>
                    <td>
                        <select onchange="changeRole(${user.id}, this.value)">
                            <option value="client" ${user.role === 'client' ? 'selected' : ''}>Клиент</option>
                            <option value="executor" ${user.role === 'executor' ? 'selected' : ''}>Исполнитель</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Менеджер</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Администратор</option>
                        </select>
                    </td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${actionsHtml}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function filterUsers() {
            const roleFilter = document.getElementById('filter-role').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            let filtered = allUsers;
            
            if (roleFilter) {
                filtered = filtered.filter(u => u.role === roleFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(u => u.status === statusFilter);
            }
            
            displayUsers(filtered);
        }
        
        function searchUsers() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchText) {
                filterUsers();
                return;
            }
            
            const filtered = allUsers.filter(u => 
                u.fullname.toLowerCase().includes(searchText) ||
                u.username.toLowerCase().includes(searchText)
            );
            
            displayUsers(filtered);
        }
        
        async function confirmUser(userId) {
            if(!confirm('Подтвердить регистрацию пользователя?')) return;
            
            try {
                await api.updateUserAdmin(userId, {
                    status: 'confirmed',
                    is_active: true
                });
                alert('Пользователь подтвержден');
                await loadUsers();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function rejectUser(userId) {
            if(!confirm('Отклонить регистрацию пользователя?')) return;
            
            try {
                await api.updateUserAdmin(userId, {
                    status: 'blocked',
                    is_active: false
                });
                alert('Регистрация отклонена');
                await loadUsers();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function blockUser(userId) {
            if(!confirm('Заблокировать пользователя?')) return;
            
            try {
                await api.updateUserAdmin(userId, {
                    is_active: false
                });
                alert('Пользователь заблокирован');
                await loadUsers();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function unblockUser(userId) {
            if(!confirm('Разблокировать пользователя?')) return;
            
            try {
                await api.updateUserAdmin(userId, {
                    is_active: true
                });
                alert('Пользователь разблокирован');
                await loadUsers();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function changeRole(userId, newRole) {
            if(!confirm('Изменить роль пользователя на: ' + newRole + '?')) {
                await loadUsers();
                return;
            }
            
            try {
                await api.updateUserAdmin(userId, {
                    role: newRole
                });
                alert('Роль пользователя изменена');
                await loadUsers();
            } catch (error) {
                alert('Ошибка: ' + error.message);
                await loadUsers();
            }
        }
        
        async function saveSettings() {
            const responseTime = document.getElementById('response-time').value;
            
            if (!responseTime || responseTime < 1) {
                alert('Введите корректное значение');
                return;
            }
            
            try {
                await api.updateSetting('response_time_hours', responseTime);
                alert('Настройки сохранены');
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function loadSettings() {
            try {
                const settings = await api.getSettings();
                const responseSetting = settings.find(s => s.key === 'response_time_hours');
                if (responseSetting) {
                    document.getElementById('response-time').value = responseSetting.value;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function logout() {
            api.removeToken();
            window.location.href = 'index.html';
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (await checkAuth()) {
                await loadUsers();
                await loadSettings();
            }
        });
    </script>
</body>
</html>
