<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Панель руководителя</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .stat-box { background: #e8f5e9; padding: 20px; text-align: center; border-radius: 5px; }
        .stat-number { font-size: 24px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; }
        select { padding: 5px; }
        button { margin: 2px; padding: 5px 10px; cursor: pointer; }
        .menu { margin: 20px 0; }
        .menu button { margin-right: 10px; }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
    <h1>Панель менеджера</h1>
    <div class="menu">
        <button onclick="showSection('dashboard')">Дашборд</button>
        <button onclick="showSection('requests')">Все заявки</button>
        <button onclick="showSection('executors')">Исполнители</button>
        <button onclick="logout()">Выйти</button>
    </div>
    
    <!-- Дашборд -->
    <div id="dashboard" class="section active">
        <h2>Статистика за месяц</h2>
        <div class="dashboard">
            <div class="stat-box">
                <div class="stat-number" id="stat-total">-</div>
                <div>Всего заявок</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-completed">-</div>
                <div>Выполнено</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-progress">-</div>
                <div>В работе</div>
            </div>
        </div>
        
        <h3>Загруженность исполнителей</h3>
        <ul id="executors-load">
            <li>Загрузка...</li>
        </ul>
    </div>
    
    <!-- Все заявки -->
    <div id="requests" class="section">
        <h2>Управление заявками</h2>
        <table>
            <thead>
                <tr>
                    <th>№</th><th>Дата</th><th>Клиент</th><th>Проблема</th>
                    <th>Статус</th><th>Назначить исполнителя</th><th>Действия</th>
                </tr>
            </thead>
            <tbody id="requests-tbody">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 20px;">Загрузка...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Исполнители -->
    <div id="executors" class="section">
        <h2>Список исполнителей</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>ФИО</th><th>Телефон</th><th>Активных задач</th>
                </tr>
            </thead>
            <tbody id="executors-tbody">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">Загрузка...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="api.js"></script>
    <script>
        let allRequests = [];
        let allExecutors = [];
        
        async function checkAuth() {
            if (!api.getToken()) {
                window.location.href = 'index.html';
                return false;
            }
            
            try {
                const user = await api.getCurrentUser();
                if (user.role !== 'manager' && user.role !== 'admin') {
                    alert('Доступ запрещен. Только для менеджеров и администраторов.');
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = 'index.html';
                return false;
            }
        }
        
        async function loadDashboard() {
            try {
                const stats = await api.getDashboardStats();
                document.getElementById('stat-total').textContent = stats.total_requests;
                document.getElementById('stat-completed').textContent = stats.completed_requests;
                document.getElementById('stat-progress').textContent = stats.in_progress_requests;
                
                // Загрузка исполнителей для отображения загруженности
                const executors = await api.getUsers({ role: 'executor' });
                const requests = await api.getRequests();
                
                const loadList = document.getElementById('executors-load');
                loadList.innerHTML = '';
                
                if (executors.length === 0) {
                    loadList.innerHTML = '<li>Нет исполнителей</li>';
                    return;
                }
                
                executors.forEach(executor => {
                    const tasksCount = requests.filter(r => 
                        r.executor_id === executor.id && 
                        (r.status === 'assigned' || r.status === 'in_progress')
                    ).length;
                    
                    const warning = tasksCount > 5 ? ' ⚠ (высокая нагрузка)' : ' ✓';
                    const li = document.createElement('li');
                    li.textContent = `${executor.fullname}: ${tasksCount} задач${warning}`;
                    loadList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        async function loadRequests() {
            try {
                allRequests = await api.getRequests();
                allExecutors = await api.getUsers({ role: 'executor' });
                
                const tbody = document.getElementById('requests-tbody');
                tbody.innerHTML = '';
                
                if (allRequests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Заявок нет</td></tr>';
                    return;
                }
                
                allRequests.forEach(request => {
                    const row = document.createElement('tr');
                    
                    const statusText = getStatusName(request.status);
                    const clientName = request.client ? request.client.fullname : 'Неизвестно';
                    const executorName = request.executor ? request.executor.fullname : 'Не назначен';
                    
                    let assignHtml = '';
                    if (!request.executor_id || request.status === 'new') {
                        assignHtml = `
                            <select id="executor-select-${request.id}">
                                <option value="">Выберите...</option>
                                ${allExecutors.map(e => 
                                    `<option value="${e.id}" ${request.executor_id === e.id ? 'selected' : ''}>${e.fullname}</option>`
                                ).join('')}
                            </select>
                            <button onclick="assignExecutor(${request.id})">Назначить</button>
                        `;
                    } else {
                        assignHtml = executorName;
                    }
                    
                    row.innerHTML = `
                        <td>${request.id}</td>
                        <td>${new Date(request.created_at).toLocaleDateString()}</td>
                        <td>${clientName}</td>
                        <td>${request.description.substring(0, 50)}...</td>
                        <td>${statusText}</td>
                        <td>${assignHtml}</td>
                        <td>
                            <button onclick="changePriority(${request.id}, ${request.priority === 3 ? 1 : 3})">
                                ${request.priority === 3 ? 'Обычный' : 'Срочный'}
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }
        
        async function loadExecutors() {
            try {
                const executors = await api.getUsers({ role: 'executor' });
                const requests = await api.getRequests();
                
                const tbody = document.getElementById('executors-tbody');
                tbody.innerHTML = '';
                
                if (executors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Исполнителей нет</td></tr>';
                    return;
                }
                
                executors.forEach(executor => {
                    const activeTasks = requests.filter(r => 
                        r.executor_id === executor.id && 
                        (r.status === 'assigned' || r.status === 'in_progress')
                    ).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${executor.id}</td>
                        <td>${executor.fullname}</td>
                        <td>${executor.username}</td>
                        <td>${activeTasks}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading executors:', error);
            }
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'requests') {
                loadRequests();
            } else if (sectionId === 'executors') {
                loadExecutors();
            }
        }
        
        async function assignExecutor(requestId) {
            const select = document.getElementById('executor-select-' + requestId);
            const executorId = select.value;
            
            if (!executorId) {
                alert('Выберите исполнителя');
                return;
            }
            
            try {
                await api.assignExecutor(requestId, parseInt(executorId));
                alert('Исполнитель назначен на заявку ' + requestId);
                await loadRequests();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function changePriority(requestId, newPriority) {
            const priorityText = newPriority === 3 ? 'срочный' : 'обычный';
            if (!confirm('Изменить приоритет заявки на: ' + priorityText + '?')) return;
            
            try {
                await api.updateRequest(requestId, { priority: newPriority });
                alert('Приоритет изменен');
                await loadRequests();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        function getStatusName(status) {
            const statuses = {
                'new': 'Новая',
                'assigned': 'Назначена',
                'in_progress': 'В работе',
                'completed': 'Выполнено',
                'cancelled': 'Отменена'
            };
            return statuses[status] || status;
        }
        
        function logout() {
            api.removeToken();
            window.location.href = 'index.html';
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (await checkAuth()) {
                await loadDashboard();
            }
        });
    </script>
</body>
</html>
